<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Acceder ‚Äî Asistencia a Informes</title>

  <!-- Bootstrap / Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <style>
    :root { --brand:#9f2241; }
    body{
      min-height:100vh; background:
      radial-gradient(1200px 600px at 80% -10%, rgba(159,34,65,.10), transparent 40%),
      radial-gradient(1000px 500px at 0% 110%, rgba(159,34,65,.08), transparent 40%),
      #f6f7fb;
    }
    .topbar { background:#fff; border-bottom:1px solid #eee; }
    .login-wrap{ display:flex; align-items:center; justify-content:center; min-height:calc(100vh - 72px); padding:24px; }
    .login-card{
      width:100%; max-width:420px; background:#fff;
      border:1px solid #ececf1; border-radius:16px; padding:24px;
      box-shadow:0 8px 30px rgba(16,24,40,.06);
    }
    .brand-dot{
      width:36px; height:36px; border-radius:10px; background:var(--brand);
      display:inline-flex; align-items:center; justify-content:center; color:#fff; margin-right:.5rem;
    }
  </style>
</head>
<body>
  <!-- Encabezado con logo -->
  <nav class="topbar">
    <div class="container d-flex align-items-center" style="height:72px;">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#" style="text-decoration:none;">
        <span class="brand-dot"><i class="bi bi-shield-lock"></i></span>
        <img src="https://lh3.googleusercontent.com/d/15DZbMCYDoQMblhjfIznTahYvBFZlGFnP" alt="Logo" height="34" />
      </a>
      <div class="ms-auto small text-muted">Acceso seguro</div>
    </div>
  </nav>

  <!-- Contenido -->
  <div class="login-wrap">
    <div class="login-card">
      <h5 class="mb-1">Iniciar sesi√≥n</h5>
      <p class="text-muted small mb-4">Ingresa tus credenciales para continuar.</p>

      <div class="mb-3">
        <label for="inpUser" class="form-label">Usuario</label>
        <input id="inpUser" class="form-control" autocomplete="username" placeholder="tu.usuario" />
      </div>

      <div class="mb-2">
        <label for="inpPass" class="form-label">Contrase√±a</label>
        <div class="input-group">
          <input id="inpPass" type="password" class="form-control" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          <button class="btn btn-outline-secondary" type="button" id="btnTogglePass" title="Mostrar/Ocultar">
            <i class="bi bi-eye"></i>
          </button>
        </div>
      </div>

      <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="chkShowPass" />
          <label class="form-check-label small" for="chkShowPass">Mostrar contrase√±a</label>
        </div>
      </div>

      <div class="d-grid">
        <button id="btnLogin" class="btn btn-primary" style="background:var(--brand); border-color:var(--brand);">
          <span class="me-1"><i class="bi bi-box-arrow-in-right"></i></span> Entrar
        </button>
      </div>

      <div id="msg" class="alert alert-danger py-2 px-3 mt-3 d-none small" role="alert"></div>

      <div class="text-center mt-3 text-muted small">¬© ATI 2025</div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    // Guardar/mandar cookies (JWT HttpOnly) en las peticiones
    axios.defaults.withCredentials = true;

    const $ = sel => document.querySelector(sel);
    const inpUser = $('#inpUser');
    const inpPass = $('#inpPass');
    const btnLogin = $('#btnLogin');
    const msg = $('#msg');

    // Mostrar / ocultar password (bot√≥n ojo)
    $('#btnTogglePass').addEventListener('click', () => {
      const isPass = inpPass.type === 'password';
      inpPass.type = isPass ? 'text' : 'password';
      $('#btnTogglePass i').className = isPass ? 'bi bi-eye-slash' : 'bi bi-eye';
    });
    // Mostrar / ocultar password (checkbox)
    $('#chkShowPass').addEventListener('change', (e) => {
      const show = e.target.checked;
      inpPass.type = show ? 'text' : 'password';
      $('#btnTogglePass i').className = show ? 'bi bi-eye-slash' : 'bi bi-eye';
    });

    // Enter para enviar
    [inpUser, inpPass].forEach(el => el.addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); }));

    // Acci√≥n de login
    btnLogin.addEventListener('click', doLogin);

    async function doLogin(){
      msg.classList.add('d-none');
      msg.textContent = '';

      const usuario = (inpUser.value || '').trim();
      const password = inpPass.value || '';

      if (!usuario || !password){
        showErr('Completa usuario y contrase√±a.');
        return;
      }

      // bot√≥n ocupado
      btnLogin.disabled = true;
      const originalHTML = btnLogin.innerHTML;
      btnLogin.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span> Verificando‚Ä¶`;

      try {
        // üîê Nuevo endpoint y formato (JSON)
        const r = await axios.post('/api/auth/login',
          { usuario, password },
          { headers: { 'Content-Type': 'application/json' } }
        );

        if (r.status === 200 && r.data?.ok) {
          // Cookie HttpOnly ya fue seteada por el backend. Vamos al home protegido.
          window.location.href = '/';
        } else {
          showErr(r.data?.error || 'Usuario o contrase√±a inv√°lidos.');
        }
      } catch (err){
        const msgSrv = err?.response?.data?.error || 'No se pudo iniciar sesi√≥n. Intenta de nuevo.';
        showErr(msgSrv);
      } finally {
        btnLogin.disabled = false;
        btnLogin.innerHTML = originalHTML;
      }
    }

    function showErr(text){
      msg.textContent = text;
      msg.classList.remove('d-none');
    }
  </script>
</body>
</html>
